# Configuración básica para el balanceo de carga y proxy
events {
    worker_connections 1024;
}

http {
    # Definimos los "upstreams", que son nuestros microservicios
    # Docker Compose se asegurará de que estos nombres se resuelvan
    
    upstream auth_service {
        # servicio-auth corre en el puerto 3001
        server servicio-auth:3001;
    }

    upstream vehiculos_service {
        # servicio-vehiculos (FastAPI) corre en el puerto 8000
        server servicio-vehiculos:8000;
    }

    upstream envios_service {
        # servicio-envios (GraphQL) corre en el puerto 3003
        server servicio-envios:3003;
    }

    # El servidor principal que escucha en el puerto 80
    server {
        listen 80;

        # ---- Ruta para el Servicio de Autenticación ----
        location /api/auth {
            # Elimina /api/auth de la URL antes de pasarla
            rewrite ^/api/auth/(.*)$ /$1 break;
            proxy_pass http://auth_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ---- Ruta para el Servicio de Vehículos (REST y Swagger) ----
        location /api/vehiculos {
            # No reescribimos la URL, FastAPI la manejará
            # (ej. /api/vehiculos/docs -> /docs en FastAPI)
            # Para esto, la ruta en FastAPI debe incluir el prefijo
            # o podemos usar 'rewrite' si es necesario.
            #
            # Corrección del plan anterior: FastAPI corre en /
            # Así que SÍ necesitamos reescribir la ruta.
            rewrite ^/api/vehiculos/(.*)$ /$1 break;
            proxy_pass http://vehiculos_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ---- Ruta para el Servicio de Envíos (GraphQL) ----
        location /graphql {
            proxy_pass http://envios_service; # gqlgen ya espera /graphql
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Necesario para WebSockets (si se usa para suscripciones GraphQL)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }
    }
}